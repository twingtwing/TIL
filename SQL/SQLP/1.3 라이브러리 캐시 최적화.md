# 🧷 라이브러리 캐시 최적화

## 🖇️ 바인드 변수

### 1. Stored vs Transient

사용자 정의 함수/프로시저, 트리거, 패키지 등은 `Stored Object`이기 때문에 생성할 때부터 이름을 갖는다. 컴파일한 상태로 딕셔너리에 저장되며, 사용자가 삭제하지 않는 한 영구적으로 보관된다. 실행할 때 라이브러리 캐시에 적재함으로써 여러 사용자가 공유하면서 재사용한다.

반면, SQL은 `Transient Object`이기 때문에 이름이 없고 SQL텍스트가 이름 역활을 하고 딕셔너리에 저장하지도 않는다. 처음 최적화 과정을 거처 동적으로 생성한 내부 프로시저를 라이브러리 캐시에 적재함으로써 여러 사용자가 공유하면서 재사용한다. 캐시 공간이 부족하면 다시 버러졌다가 다음에 다시 실행할때 다시 최적화 과정을 거쳐서 재사용한다. 

IBM DB2같은 DBMS는 SQL도 영구적으로 저장가능하지만, 오라클/SQL Server 같은 DBMS은 그렇게 하지 않는다. SQL 자체가 이름이기 때문에 작은 부분이라도 다르면 같은 객체가 아니기 때문이다. 무수히 많은 객체들을 모두 저장하려하면 많은 공간이 필요하고, 그만큼 SQL을 찾는 속도도 느려기지 때문이다.

### 2. 바인드 변수의 중요성

#### 동시 다발적 하드 파싱 발생

I/O가 거의 일어나지 않아도 동시다발적으로 발생하는 SQL 하드파싱으로 CPU사용률이 급격히 올라가서 DBMS에 부하가 발생할 수 있다. 예로 들어 이벤트로 인한 동시 시스템 접속으로 인한 로그인이 대량으로 발생하게 되었다.  

for loop을 통해 조건절 비교 값을 변경해서 SQL을 실행 할 경우, 각각의 SQL에 대해 커서가 따로 생성되고 매번 하드 파싱을 발생시킨다. 또한, SQL 옵티마이저와 로우 생성기가 만든 내부 프로시저가 대량으로 적재하게 된다. 

#### 공유 가능한 SQL

이를 막기 위해 파라미터 Driven 방식으로 SQL을 작성하는 방법이 제공되는데, 바인드 변수가 바로 그것이다. 이를 사용한 경우 라이브러리 캐시를 조회하면 다수의 비슷한 SQL들이 아닌 아래의 SQL 하나만 발견된다. 

    SELECT * FROM TABLE FROM ID = :1

이 SQL에 대한 하드파싱은 최초 한번만 일어나고, 하나의 프로시저를 공유하면서 반복 재사용할 수 있게 되면서 아래와 같이 DBMS 부하를 줄일 수 있다.

- 커서를 많이 생성하지 않는다.
- 하나를 반복 재사용하므로 메모리 사용량과 파싱소요시간을 줄여준다.
- 메모리와 CPU 사용률을 낮춰 데이터베이스 성능과 확장성을 높이는데 기여한다.
- 동시 사용자 접속이 많을때, 높은 효율을 가지고 온다.

### 3. 바인드 변수의 부작용

바인드 변수를 사용하면 최초 수행할 때 최적화를 거친 실행계획을 캐시에 적재하고, 실행시점에는 그대로 가져와 값을 다르게 바인딩하면서 반복 재사용하게 된다. 이때 최적화하는 시점에 조건절 컬럼의 컬럼 히스토그램 정보를 사용하지 못한다. 따라서 평균 분포를 가정한 실행계획을 생성해서 사용하기 때문에 경우에 따라서 최적이 아닐 수 있다.

#### (1) 바인드 변수 Peeking

바인드 변수의 부작용을 극복하기 위해 오라클 9i부터 도입된 기능이다. SQL이 첫 번째 수행되면서 하드파싱될 때 함께 딸려 온 바인드 변수 값을 살짝 훔쳐 보고, 그 값에 대한 컬럼 분포를 이용해 실행계획을 결정하는 것이다. (SQL Server, Parameter Sniffing)

그러나, 실행계획을 잘못 수립된 경우 갑자기 느려지는 현상이 발생할 수 있다. 뿐만 아니라 자주 실행계획이 바뀌어 수행속도가 급격히 달라지는 현상이 발생할 수 있기 때문에 현재는 대부분 비활성된 상태로 운영중이다.

#### (2) 적응적 커서 공유(Adaptive Cursor Sharing)

11g에 도입된 기능으로, 입력된 바인드 변수 값의 분포에 따라 다른실행계획이 사용되도록 하는 것이다.

#### (3) 입력 값에 따라 SQL 분리

#### (4) 예외적으로, Literal 상수값 사용

## 🖇️ 세션 커서 캐싱 기능

## 🖇️ 애플리케이션 커서 캐싱



## Reference

- [친절한SQL 튜닝](https://product.kyobobook.co.kr/detail/S000001975837)
- [오라클 성능고도화 원리와 해법 1](https://product.kyobobook.co.kr/detail/S000061696047)